# 报告质量可控与定制化完整解决方案 (V7.0)

**日期**：2026-01-12
**目标**：构建一套“所见即所得、结构可控、内容可定”的专业报告生成体系。

---

## 🏛️ 核心架构：三位一体质量控制模型

为了彻底解决“AI生成内容不可控”和“报告难以定制”的痛点，我们提出以下技术方案：

### 1. 📝 人机协作层：引入 TipTap 富文本编辑器
**现状**：目前报告是静态 HTML，生成后无法修改，错一个字都要重新生成。
**方案**：将报告展示区升级为 **TipTap 编辑器**。
*   **所见即所得**：AI 生成的内容直接填充进编辑器，用户可以直接在网页上删改、加粗、调整段落，就像在 Word 里一样。
*   **局部重写**：针对“痛点分析”等 AI 生成不稳定的板块，增加“✨ 重写本段”按钮，利用 AI 重新生成指定段落，直到满意为止。
*   **模板插入**：提供“专家话术库”，用户可以点击插入预设的专业法律/税务条款，无需手打。

### 2. ⚙️ 后端控制层：JSON 结构化强约束
**现状**：目前 Prompt 是让 AI 写“一篇长文”，AI 容易偷懒或跑题。
**方案**：强制 AI 输出 **JSON 数据结构**。
*   **Schema 定义**：
    ```json
    {
      "executive_summary": {
        "background": "200字...",
        "risk_highlight": "200字..."
      },
      "risk_analysis": [
        { "title": "税务风险", "content": "300字深度推演...", "severity": "high" },
        { "title": "传承风险", "content": "...", "severity": "medium" }
      ]
    }
    ```
*   **字数守门员 (Length Guard)**：后端代码会自动统计 JSON 字段的字数。如果 `executive_summary` 少于 800 字，系统会自动驳回请求，命令 AI 重新扩写，直到达标才返回给前端。

### 3. 🎛️ 定制化配置层：生成前配置面板 (Pre-flight Config)
**现状**：点击“生成”就一键出结果，用户无法干预方向。
**方案**：在生成前增加一个 **“定制向导”** 弹窗。
*   **侧重方向选择**：提供 [税务合规]、[家族传承]、[资产隔离]、[身份规划] 四个选项。选择不同方向，会调用不同的 System Prompt，让 AI 的分析重心完全不同。
*   **语气风格选择**：[严肃保守]、[现代进取]、[温和教育]。
*   **板块开关**：用户可以勾选“是否包含‘家族叙事’”、“是否包含‘资产图表’”，按需生成简版或详版报告。

---

## 📅 分阶段实施计划

### Phase 1: 编辑器集成 (本周)
1.  安装 `tiptap` 及其插件。
2.  将 `SmartReportView` 中的文本展示区替换为可编辑的 `EditorContent`。
3.  实现“保存修改”功能，将用户修订后的内容存入历史记录。

### Phase 2: JSON 结构化改造 (下周)
1.  重写 `ReportService`，弃用纯文本 Prompt，全面转向 JSON Schema。
2.  实现后端字数校验逻辑。

### Phase 3: 定制化向导 (下下周)
1.  开发 `ReportConfigDialog` 组件。
2.  配置多套 Prompt 模板以适配不同侧重方向。

---

## 💡 为什么这个方案能解决问题？
*   **图谱溢出**：已通过 CSS `overflow: hidden` 和强制缩放逻辑修复。
*   **内容不可控**：通过 JSON 强制 AI 按格式填空，不给它“自由发挥”导致跑题的机会。
*   **定制需求**：通过 TipTap 让用户拥有最终决定权，通过配置向导让 AI 懂用户意图。

**建议立即启动 Phase 1 开发，让您先体验到“可修改”的便利。**
