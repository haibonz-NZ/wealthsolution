# è·¨å›½å®¶æ—åŠå…¬å®¤ç³»ç»Ÿ - é¡¹ç›®å…¨æ¡ˆç™½çš®ä¹¦ (Project Master Documentation)

**ç”Ÿæˆæ—¥æœŸ**ï¼š2026-01-13
**å½“å‰ç‰ˆæœ¬**ï¼šCode V6.4 / Spec V13.0
**æ–‡æ¡£è¯´æ˜**ï¼šæœ¬æ–‡æ¡£æ±‡æ€»äº†é¡¹ç›®çš„æ‰€æœ‰éœ€æ±‚è§„æ ¼ã€æŠ€æœ¯è®¾è®¡ã€ç®—æ³•é€»è¾‘åŠå½“å‰ä»£ç çŠ¶æ€ï¼Œæ˜¯é¡¹ç›®çš„â€œå”¯ä¸€çœŸç†æ¥æº (Single Source of Truth)â€ã€‚

---

# ğŸ“… é¡¹ç›®è¿›åº¦ä¸å˜æ›´æ—¥å¿— (Changelog)

## å½“å‰çŠ¶æ€ï¼šV6.4 (ç¨³å®šè¿è¡Œç‰ˆ)
*   **å®¢æˆ·ç«¯ (Client)**: `wealth-solution-client` (H5)
    *   âœ… **è§†è§‰é‡æ„**ï¼šææ·±è“/å¤é“œ/å¥¶æ²¹è‰² VI è½åœ°ã€‚
    *   âœ… **èº«ä»½äº¤äº’**ï¼šæ‹–æ‹½å¼èº«ä»½å½•å…¥ + 8å›½åœ°å›¾ + è‡ªåŠ¨å¼¹çª—é—®å·ã€‚
    *   âœ… **è¯Šæ–­å¼•æ“**ï¼šäº”ç»´é›·è¾¾å›¾ + é£é™©çº¢ç»¿ç¯ + æŸç›Šæ¨¡æ‹Ÿå™¨ (å«ç¦»å¢ƒç¨é€»è¾‘)ã€‚
    *   âœ… **ç¨³å®šæ€§ä¿®å¤**ï¼šWizardContext æ•°æ®è‡ªæ„ˆæœºåˆ¶ (ä¿®å¤ç™½å±å´©æºƒ)ã€‚
*   **é¡¾é—®ç«¯ (Web)**: `wealth-solution-web` (Admin)
    *   âœ… **å›¾è°±ä¿®å¤**ï¼šè§£å†³å®¶æ—æ ‘æº¢å‡ºé—®é¢˜ (Fit Width)ã€‚
    *   âœ… **AI å¼•æ“**ï¼šåˆ‡æ¢è‡³ DeepSeek (ç›´è¿/ä»£ç†åŒæ¨¡å¼)ã€‚
    *   âœ… **æ¼”ç¤ºåŠŸèƒ½**ï¼šä¸€é”®å¯¼å…¥ Demo æ¡ˆä¾‹ã€‚

---

# è·¨å›½å®¶æ—åŠå…¬å®¤æ™ºèƒ½æŠ¥å‘Šç³»ç»Ÿ - åƒç´ çº§æ‰§è¡Œè§„æ ¼ä¹¦ (SRS V12.0)

**ç‰ˆæœ¬**ï¼šV12.0 (Pixel-Perfect Execution Guide)
**å¯†çº§**ï¼šæ ¸å¿ƒæœºå¯†
**é€‚ç”¨å¯¹è±¡**ï¼šå‰ç«¯å¼€å‘ã€åç«¯å¼€å‘ã€UIè®¾è®¡ã€æµ‹è¯•
**æ–‡æ¡£è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åŒ…å«ç³»ç»Ÿæ‰€æœ‰é¡µé¢çš„**UIç»†èŠ‚**ã€**æ–‡æ¡ˆå†…å®¹**ã€**äº¤äº’é€»è¾‘**åŠ**åº•å±‚ç®—æ³•**ã€‚å¼€å‘äººå‘˜è¯·ä¸¥æ ¼éµå®ˆæœ¬æ–‡æ¡£è¿›è¡Œç¼–ç ã€‚

---

# ğŸ¨ ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨å±€è®¾è®¡è§„èŒƒ (Design System)

## 1.1 è‰²å½©ç³»ç»Ÿ (Color Palette)
æ‰€æœ‰é¢œè‰²å¿…é¡»ä½¿ç”¨ CSS å˜é‡ï¼Œä½†åœ¨ä»£ç ä¸­éœ€ç¡¬ç¼–ç ä»¥ä¸‹åŸºå‡†å€¼ï¼š
*   **èƒŒæ™¯è‰² (Background)**: `#0C2340` (æ·±é‚ƒè“ - é¡µé¢åº•è‰²)
*   **ä¸»è‰² (Primary)**: `#B87845` (å¤é“œé‡‘ - æŒ‰é’®ã€é«˜äº®ã€å›¾æ ‡)
*   **è¾…è‰² (Secondary)**: `#FFF2CC` (å¥¶æ²¹ç™½ - å¡ç‰‡èƒŒæ™¯ã€æ–‡å­—å®¹å™¨)
*   **æ–‡æœ¬è‰² (Text-Main)**: `#FFF2CC` (æ·±åº•ä¸Šçš„æ–‡å­—)
*   **æ–‡æœ¬è‰² (Text-Inverse)**: `#0C2340` (æµ…åº•ä¸Šçš„æ–‡å­—)
*   **åŠŸèƒ½è‰²**:
    *   ğŸ”´ å±é™©/é«˜å±: `#EF4444` (Tailwind `red-500`)
    *   ğŸŸ¡ è­¦å‘Š/ä¸­å±: `#F59E0B` (Tailwind `amber-500`)
    *   ğŸŸ¢ å®‰å…¨/é€šè¿‡: `#10B981` (Tailwind `green-500`)

## 1.2 å­—ä½“æ’å° (Typography)
*   **æ ‡é¢˜ (Heading)**: `Cinzel` (Google Font), å­—é‡ 700/900.
*   **æ­£æ–‡ (Body)**: `Lato` æˆ– `Noto Sans SC` (Google Font), å­—é‡ 400.
*   **æ•°å­—/ä»£ç **: `Montserrat`, å­—é‡ 600.

---

# ğŸ“± ç¬¬äºŒéƒ¨åˆ†ï¼šå®¢æˆ·å‰å° (C-End) é¡µé¢è¯¦è§£

## é¡µé¢ 2.1ï¼šé—¨å…ç€é™†é¡µ (Landing)
**è·¯ç”±**: `/`

### 2.1.1 ç•Œé¢å…ƒç´ ä¸æ–‡æ¡ˆ
1.  **é¡¶éƒ¨è·‘é©¬ç¯**:
    *   *èƒŒæ™¯*: `#FFF2CC` (10% é€æ˜åº¦)
    *   *æ–‡æ¡ˆåº“* (éšæœºå¾ªç¯):
        *   "æŸä¸Šæµ·ç±å®¶æ—åˆšåˆšå®Œæˆç¾/æ—¥é£é™©æ‰«æ"
        *   "æŸåŒ—äº¬ç±ä¼ä¸šå®¶æ­£åœ¨è¿›è¡Œä»£æŒæ¶æ„ä½“æ£€"
        *   "æŸæ·±åœ³ç±å®¢æˆ·å‘ç°ç¦»å²¸ä¿¡æ‰˜åˆè§„æ¼æ´"
2.  **å®‰å…¨æµ®çª— (å³ä¸Šè§’)**:
    *   *å›¾æ ‡*: ğŸ›¡ï¸ (ShieldCheck)
    *   *æ–‡æ¡ˆ*: "AES-256 åŠ å¯† | åŒ¿åè®¿é—®"
3.  **Hero åŒºåŸŸ**:
    *   *Logo*: æ˜¾ç¤º `src/assets/logo-one.png`
    *   *ä¸»æ ‡é¢˜*: "é¢„è§è·¨å¢ƒéšå¿§ï¼Œå®ˆæŠ¤å®¶åº­é•¿é’" (å­—å· 48px, Cinzel)
    *   *å‰¯æ ‡é¢˜*: "åŸºäºå¤§æ•°æ®çš„æ™ºèƒ½åŒ–å®¶åº­è´¢å¯Œä½“æ£€æ–¹æ¡ˆ" (å­—å· 18px, Lato)
    *   *CTA æŒ‰é’®*:
        *   *æ–‡æ¡ˆ*: "ç«‹å³å¼€å¯ä½“æ£€"
        *   *æ ·å¼*: å¤é“œè‰²å¡«å……ï¼Œåœ†è§’çŸ©å½¢ï¼Œæµå…‰åŠ¨ç”»ã€‚
    *   *åº•éƒ¨èƒŒä¹¦*: "3åˆ†é’Ÿæç®€åŒ¿åä½“æ£€ Â· ç”± GWRC æ™ºèƒ½å¼•æ“é©±åŠ¨"

### 2.1.2 äº¤äº’é€»è¾‘
*   **ç‚¹å‡» CTA æŒ‰é’®**: `history.push('/wizard/identity')`
*   **URL å‚æ•°è§£æ**:
    *   è¯»å– `?advisor_id=XYZ`ã€‚
    *   è‹¥æœ‰å€¼ï¼Œå­˜å…¥ `sessionStorage.setItem('gwrc_advisor_id', 'XYZ')`ã€‚
    *   é¡µé¢åº•éƒ¨æ˜¾ç¤ºé¡¾é—®åç‰‡ç»„ä»¶ï¼ˆå¤´åƒ+IDï¼‰ã€‚

---

## é¡µé¢ 2.2ï¼šèº«ä»½æ‹“æ‰‘å½•å…¥ (Identity Wizard)
**è·¯ç”±**: `/wizard/identity`

### 2.2.1 ç•Œé¢å¸ƒå±€
*   **å·¦ä¾§ (Desktop) / åº•éƒ¨ (Mobile)**: **èº«ä»½æ‰˜ç›˜ (Dock)**
    *   åŒ…å« 4 ä¸ªåœ†å½¢å¯æ‹–æ‹½å›¾æ ‡ï¼š
        *   `User` (æœ¬äºº)
        *   `Users` (é…å¶)
        *   `Baby` (å­å¥³)
        *   `Tent` (çˆ¶æ¯)
*   **ä¸­å¿ƒ**: **äº¤äº’åœ°å›¾ (Map)**
    *   èƒŒæ™¯å›¾: `world-map.jpeg`
    *   8 ä¸ªçƒ­åŒº (DropZone): `CN`, `US`, `UK`, `CA`, `AU`, `JP`, `HK`, `SG`ã€‚

### 2.2.2 äº¤äº’ä¸å¼¹çª—é€»è¾‘ (The Logic Core)
*å½“å›¾æ ‡è¢« Drop åˆ°ç‰¹å®šåŒºåŸŸæ—¶ï¼Œè§¦å‘ä»¥ä¸‹æ¨¡æ€æ¡† (Modal)*ï¼š

#### **åœºæ™¯ A: æ‹–å…¥ [ç¾å›½ US]**
*   **å¼¹çª—æ ‡é¢˜**: "ç¾å›½ç¨åŠ¡æ·±åº¦æ‰«æ"
*   **é—®é¢˜ 1**: "è¯¥æˆå‘˜æŒæœ‰ç¾å›½æŠ¤ç…§ã€ç»¿å¡ï¼Œæˆ–æ­£åœ¨ç”³è¯·ç»¿å¡ï¼Ÿ"
    *   *é€‰é¡¹*: [æ˜¯] / [å¦]
    *   *é€»è¾‘*: é€‰ [æ˜¯] -> Tag: `US_IDENTITY`
*   **é—®é¢˜ 2**: "è¯¥æˆå‘˜æœ¬å¹´åº¦æ˜¯å¦åœ¨ç¾å±…ä½è¶…è¿‡ 31 å¤©ï¼Œä¸”ä¸‰å¹´ç´¯è®¡æ»¡ 183 å¤©ï¼Ÿ"
    *   *é€‰é¡¹*: [æ˜¯] / [å¦]
    *   *é€»è¾‘*: é€‰ [æ˜¯] -> Tag: `US_SUBSTANTIAL_PRESENCE`
*   **é—®é¢˜ 3 (ä»…å½“ Q1æˆ–Q2 ä¸ºæ˜¯)**: "æ˜¯å¦æŒæœ‰éç¾ç±äº²å±èµ ä¸çš„èµ„äº§ (>10ä¸‡ç¾å…ƒ)ï¼Ÿ"
    *   *é€‰é¡¹*: [æ˜¯] / [å¦]
    *   *é€»è¾‘*: é€‰ [æ˜¯] -> Tag: `US_GIFT_REPORTING`

#### **åœºæ™¯ B: æ‹–å…¥ [åŠ æ‹¿å¤§ CA] æˆ– [æ¾³å¤§åˆ©äºš AU]**
*   **å¼¹çª—æ ‡é¢˜**: "ç¦»å¢ƒ/ç¨åŠ¡å±…æ°‘åˆ¤å®š"
*   **é—®é¢˜ 1**: "æ˜¯å¦ä¸ºè¯¥å›½ç¨åŠ¡å±…æ°‘ï¼Ÿ"
    *   *é€‰é¡¹*: [æ˜¯] / [å¦]
    *   *é€»è¾‘*: é€‰ [æ˜¯] -> Tag: `CA_RESIDENT` / `AU_RESIDENT`
*   **é—®é¢˜ 2**: "æœªæ¥æ˜¯å¦æœ‰é•¿æœŸç¦»å¼€è¯¥å›½ï¼ˆå›æµä¸­å›½ï¼‰çš„è®¡åˆ’ï¼Ÿ"
    *   *é€‰é¡¹*: [æ˜¯] / [å¦]
    *   *é€»è¾‘*: é€‰ [æ˜¯] -> Tag: `DEPARTURE_TAX_RISK` (ç¦»å¢ƒç¨é£é™©)

#### **åœºæ™¯ C: æ‹–å…¥ [æ—¥æœ¬ JP]**
*   **å¼¹çª—æ ‡é¢˜**: "ç»§æ‰¿ç¨åˆ¤å®š"
*   **é—®é¢˜ 1**: "åœ¨æ—¥æœ¬å±…ä½æ˜¯å¦è¶…è¿‡ 10 å¹´ï¼Ÿ"
    *   *é€‰é¡¹*: [æ˜¯] / [å¦]
    *   *é€»è¾‘*: é€‰ [æ˜¯] -> Tag: `JP_UNLIMITED_LIABILITY` (æ— é™åˆ¶çº³ç¨ä¹‰åŠ¡)

---

## é¡µé¢ 2.3ï¼šèµ„äº§å½•å…¥ (Assets Wizard)
**è·¯ç”±**: `/wizard/assets`

### 2.3.1 ç•Œé¢å…ƒç´ 
*   **å¢ƒå†…èµ„äº§æ»‘å—**:
    *   *Label*: "å¢ƒå†…èµ„äº§é¢„ä¼° (RMB)"
    *   *Steps*: 0 (<1000ä¸‡), 1 (1000-5000ä¸‡), 2 (5000ä¸‡-1äº¿), 3 (>1äº¿)
*   **å¢ƒå¤–èµ„äº§æ»‘å—**:
    *   *Label*: "å¢ƒå¤–èµ„äº§é¢„ä¼° (USD)"
    *   *Steps*: 0 (<100ä¸‡), 1 (100-500ä¸‡), 2 (500-2000ä¸‡), 3 (>2000ä¸‡)
*   **èµ„äº§ç±»å‹å¤šé€‰ (Grid)**:
    *   `RealEstate` (æˆ¿äº§) -> å…³è”é£é™©: æµåŠ¨æ€§ã€é—äº§ç¨
    *   `Equity` (è‚¡æƒ) -> å…³è”é£é™©: CFC ç©¿é€
    *   `Trust` (ä¿¡æ‰˜) -> å…³è”é£é™©: 3520A ç”³æŠ¥
    *   `Insurance` (ä¿å•) -> å…³è”é£é™©: 7702 åˆè§„æ€§

---

## é¡µé¢ 2.4ï¼šè¯Šæ–­æŠ¥å‘Šé¡µ (Diagnosis)
**è·¯ç”±**: `/diagnosis`

### 2.4.1 äº”ç»´é›·è¾¾å›¾ç®—æ³•
*   **ç»´åº¦**: ç¨åŠ¡(Tax), å®‰å…¨(Security), ä¼ æ‰¿(Succession), éšç§(Privacy), åˆè§„(Compliance).
*   **åˆå§‹åˆ†**: 100 åˆ†ã€‚
*   **æ‰£åˆ†çŸ©é˜µ**:
    *   `US_IDENTITY` -> Tax -30, Compliance -20
    *   `DEPARTURE_TAX_RISK` -> Tax -20, Security -10
    *   `JP_UNLIMITED_LIABILITY` -> Tax -40
    *   `Trust` (æ— è§„åˆ’) -> Compliance -10 (å‡è®¾æœªç”³æŠ¥)
    *   `Equity` + `US_IDENTITY` -> Tax -20 (CFCé£é™©)

### 2.4.2 é£é™©çº¢ç»¿ç¯æ–‡æ¡ˆåº“ (Risk Copywriting)
*å‰ç«¯æ ¹æ® Tags æ˜¾ç¤ºå¯¹åº”çš„å¡ç‰‡*ï¼š

| Tag | æ ‡é¢˜ (Title) | æè¿°æ–‡æ¡ˆ (Description) | ä¸“å®¶è§£é‡Š (Popover) |
| :--- | :--- | :--- | :--- |
| `US_IDENTITY` | **ç¾ç±èº«ä»½ç¨åŠ¡åˆè§„** | æ‚¨çš„å®¶åº­æˆå‘˜æ¶‰åŠç¾å›½ç¨åŠ¡å±…æ°‘èº«ä»½ï¼Œé¢ä¸´å…¨çƒå¾ç¨ä¹‰åŠ¡ã€‚ | ç¾å›½å®è¡Œå…¨çƒå¾ç¨ï¼ˆCitizenship-based Taxationï¼‰ã€‚ç»¿å¡/å…¬æ°‘éœ€ç”³æŠ¥å…¨çƒæ”¶å…¥ï¼Œä¸”å—æ§å¤–å›½å…¬å¸(CFC)åŠè¢«åŠ¨æŠ•èµ„(PFIC)é¢ä¸´æƒ©ç½šæ€§ç¨ç‡ã€‚ |
| `DEPARTURE_TAX_RISK` | **ç¦»å¢ƒæ¸…ç®—ç¨é£é™©** | ç¦»å¼€åŠ /æ¾³æ—¶ï¼Œåä¸‹èµ„äº§å¯èƒ½è¢«è§†ä¸ºâ€œæŒ‰å¸‚ä»·å‡ºå”®â€å¹¶å¾ç¨ã€‚ | åŠ æ‹¿å¤§/æ¾³æ´²ç¨æ³•è§„å®šï¼Œç¨åŠ¡å±…æ°‘åˆ‡æ–­ç¨åŠ¡è”ç³»æ—¶ï¼Œéœ€å¯¹åä¸‹å…¨çƒèµ„äº§ï¼ˆç‰¹å®šè±å…é™¤å¤–ï¼‰è®¡ç®—èµ„æœ¬åˆ©å¾—ç¨ï¼ˆDeemed Dispositionï¼‰ã€‚ |
| `JP_UNLIMITED_LIABILITY` | **æ—¥æœ¬é«˜é¢ç»§æ‰¿ç¨** | å±…ä½è¶…10å¹´è§¦å‘â€œæ— é™åˆ¶çº³ç¨ä¹‰åŠ¡â€ï¼Œå…¨çƒèµ„äº§ç»§æ‰¿ç¨æœ€é«˜55%ã€‚ | æ—¥æœ¬ç»§æ‰¿ç¨æ³•è§„å®šï¼Œé•¿æœŸå±…æ°‘ï¼ˆ10å¹´ä¸­ä½æ»¡Xå¹´ï¼‰éœ€å°±å…¨çƒèµ„äº§ç¼´çº³ç»§æ‰¿ç¨ï¼Œæ— è®ºèµ„äº§ä½äºä½•å¤„ï¼Œç¨ç‡ç´¯è¿›æœ€é«˜è¾¾55%ã€‚ |
| `US_GIFT_REPORTING` | **è·¨å¢ƒèµ ä¸ç”³æŠ¥** | æ¥æ”¶éç¾äººå£«å¤§é¢èµ ä¸ï¼ˆ>$10Wï¼‰éœ€æäº¤3520è¡¨ã€‚ | è‹¥æœªåŠæ—¶ç”³æŠ¥ 3520 è¡¨ï¼Œç¾å›½å›½ç¨å±€å¯å¤„ä»¥èµ ä¸é‡‘é¢ 5% è‡³ 25% çš„ç½šæ¬¾ã€‚ |

### 2.4.3 æŸç›Šæ¨¡æ‹Ÿå™¨ç®—æ³•
*   **åœºæ™¯**: "ä»£é™…ä¼ æ‰¿æŸç›Šé¢„æ¼”"
*   **å…¬å¼**:
    ```javascript
    let lossRate = 0;
    if (tags.includes('US_IDENTITY')) lossRate += 0.40; // 40% é—äº§ç¨
    if (tags.includes('JP_UNLIMITED_LIABILITY')) lossRate = Math.max(lossRate, 0.55); // 55% è¦†ç›–
    if (tags.includes('DEPARTURE_TAX_RISK')) lossRate += 0.25; // ä¼°ç®—25%ç¦»å¢ƒç¨
    
    // åŸºç¡€æŸè€— (å¾‹å¸ˆè´¹/é€šèƒ€/å†»ç»“)
    lossRate += 0.05; 
    
    const remaining = 1.0 - Math.min(lossRate, 0.80); // æœ€å¤šå‰© 20%
    ```
*   **å±•ç¤º**: è¿›åº¦æ¡ä» 100% ç¼©å‡åˆ° `remaining * 100`%ã€‚

---

# ğŸ–¥ï¸ ç¬¬ä¸‰éƒ¨åˆ†ï¼šé¡¾é—®åå° (B-End) é¡µé¢è¯¦è§£

## é¡µé¢ 3.1ï¼šçº¿ç´¢ç®¡ç† (Lead Dashboard)
**è·¯ç”±**: `/dashboard`
*   **åˆ—è¡¨å­—æ®µ**: 
    *   `æäº¤æ—¶é—´`
    *   `å®¢æˆ·æ‰‹æœºå·` (è„±æ•: 138****1234)
    *   `é£é™©ç­‰çº§` (é«˜/ä¸­/ä½ - ç”±å‰å°ç®—æ³•é€ä¼ )
    *   `èµ„äº§è§„æ¨¡` (é«˜å‡€å€¼/è¶…é«˜å‡€å€¼)
    *   `æ“ä½œ`: [æŸ¥çœ‹è¯¦æƒ…] [è½¬ä¸ºæ¡ˆä¾‹]

## é¡µé¢ 3.2ï¼šæŠ¥å‘Šç¼–è¾‘å™¨ (Report Editor)
**è·¯ç”±**: `/cases/:id/report`
*   **ç»„ä»¶**: `TipTap` (Rich Text Editor)
*   **é¢„è®¾æ¨¡ç‰ˆ**: 
    *   ç³»ç»Ÿæ ¹æ® C ç«¯ä¼ æ¥çš„ Tagsï¼Œè‡ªåŠ¨ç»„åˆ JSONï¼š
    ```json
    {
      "summary": "åŸºäºæ‚¨ [US_IDENTITY] åŠ [Trust] çš„æƒ…å†µï¼Œæˆ‘ä»¬å»ºè®®...",
      "risks": [ ...å¯¹åº”æ–‡æ¡ˆ... ],
      "solutions": [ ...å¯¹åº”æ–‡æ¡ˆ... ]
    }
    ```
*   **åŠŸèƒ½**: é¡¾é—®å¯åœ¨ç½‘é¡µä¸Šç›´æ¥ä¿®æ”¹ä¸Šè¿°è‡ªåŠ¨ç”Ÿæˆçš„æ–‡å­—ï¼Œç‚¹å‡»ä¿å­˜åç”Ÿæˆ PDFã€‚

---

# ğŸ”Œ ç¬¬å››éƒ¨åˆ†ï¼šæ•°æ®æ¥å£è§„èŒƒ (API Docs)

## 4.1 æäº¤çº¿ç´¢ (Submit Lead)
*   **Endpoint**: `POST /api/leads`
*   **Request Body**:
    ```json
    {
      "advisor_id": "12345",
      "phone": "13800138000",
      "data": {
        "identities": [ ... ],
        "assets": { ... },
        "risks": ["US_IDENTITY", "DEPARTURE_TAX_RISK"] // å‰ç«¯è®¡ç®—å¥½çš„ Tag
      }
    }
    ```

---

**é™„å½•ï¼šå¼€å‘ä¼˜å…ˆçº§ (Sprint Planning)**
1.  **Sprint 1**: å®Œæˆ C ç«¯æ‰€æœ‰é¡µé¢ UI åŠ â€œç¾å›½/åŠ æ¾³â€ çš„å¼¹çª—é€»è¾‘ (å·²éƒ¨åˆ†å®Œæˆ)ã€‚
2.  **Sprint 2**: å®Œæˆ â€œäº”ç»´é›·è¾¾å›¾â€ å’Œ â€œæŸç›Šæ¨¡æ‹Ÿå™¨â€ çš„çœŸå®ç®—æ³•å¯¹æ¥ (Diagnosis é¡µ)ã€‚
3.  **Sprint 3**: å¼€å‘ B ç«¯ â€œçº¿ç´¢æ¥æ”¶â€ å’Œ â€œæŠ¥å‘Šç¼–è¾‘å™¨â€ (Report é¡µ)ã€‚
# è·¨å›½å®¶æ—åŠå…¬å®¤ç³»ç»Ÿ - V13.0 å…¨æ ˆå¼€å‘è“å›¾ (The Technical Blueprint)

**ç‰ˆæœ¬**ï¼šV13.0
**æ€§è´¨**ï¼šæŠ€æœ¯è®¾è®¡æ–‡æ¡£ (TDD)
**å—ä¼—**ï¼šé«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆ
**ç›®æ ‡**ï¼šæä¾›â€œå¤åˆ¶ç²˜è´´çº§â€çš„ä»£ç é€»è¾‘å’Œç»„ä»¶è§„èŒƒï¼Œæ¶ˆé™¤æ‰€æœ‰å®ç°æ­§ä¹‰ã€‚

---

## 1. å…¨å±€æ•°æ®æ¶æ„ (Global Data Architecture)

### 1.1 ç±»å‹å®šä¹‰ (`src/contexts/WizardContext.tsx`)

è¿™æ˜¯ç³»ç»Ÿçš„æ•°æ®è„Šæ¢ã€‚æ‰€æœ‰é¡µé¢å¿…é¡»ä¸¥æ ¼éµå¾ªæ­¤ Schemaã€‚

```typescript
// 8å¤§æ ¸å¿ƒç®¡è¾–åŒºæšä¸¾
export type IdentityRegion = "CN" | "HK" | "US" | "UK" | "CA" | "AU" | "SG" | "JP" | "OTHER";

// å®¶åº­è§’è‰²æšä¸¾
export type RoleType = "self" | "spouse" | "child" | "parent" | "grandchild";

// èº«ä»½èŠ‚ç‚¹ï¼ˆæ‹–æ‹½ç”Ÿæˆçš„å¯¹è±¡ï¼‰
export interface IdentityNode {
  id: string;           // UUID, e.g., "id-17098234"
  role: RoleType;       // è§’è‰²
  region: IdentityRegion; // æ‰€åœ¨å›½å®¶
  risks: string[];      // è§¦å‘çš„é£é™©æ ‡ç­¾, e.g., ["US_TAX_PERSON", "PFIC"]
  meta?: {              // é¢å¤–å…ƒæ•°æ®
    daysInCountry?: number; // å±…ä½å¤©æ•°
    citizenship?: boolean;  // æ˜¯å¦å…¬æ°‘
  };
}

// èµ„äº§ç»“æ„
export interface AssetProfile {
  domesticLevel: 0 | 1 | 2 | 3; // 0:<1000w, 1:1-5kw, 2:5kw-1e, 3:>1e
  foreignLevel: 0 | 1 | 2 | 3;  // 0:<100w, 1:1-500w, 2:500-2000w, 3:>2000w
  types: Array<"real_estate" | "equity" | "cash" | "insurance" | "trust" | "crypto">;
}

// å…¨å±€çŠ¶æ€ä¸Šä¸‹æ–‡
export interface WizardData {
  advisorId?: string;       // é¡¾é—®ID (from URL)
  identities: IdentityNode[]; // èº«ä»½æ‹“æ‰‘
  assets: AssetProfile;     // èµ„äº§æ¦‚å†µ
  painPoints: string[];     // ç—›ç‚¹ ID åˆ—è¡¨
  leadInfo?: {              // ç•™èµ„ä¿¡æ¯
    phone: string;
    submittedAt: string;
  };
}
```

### 1.2 æŒä¹…åŒ–å­˜å‚¨ (LocalStorage)
*   **Key**: `gwrc_wizard_data`
*   **Strategy**: `useEffect` ç›‘å¬ `data` å˜åŒ–è‡ªåŠ¨å†™å…¥ï¼›åº”ç”¨å¯åŠ¨æ—¶ `useState` æ‡’åŠ è½½è¯»å–ã€‚
*   **é˜²è…å±‚**: è¯»å–æ—¶å¿…é¡»æ ¡éªŒ `identities` æ˜¯å¦ä¸ºæ•°ç»„ï¼Œé˜²æ­¢æ—§ç‰ˆæœ¬æ•°æ®å¯¼è‡´ç™½å±ï¼ˆå·²åœ¨ V6.4 å®ç°ï¼‰ã€‚

---

## 2. æ ¸å¿ƒç®—æ³•å®ç° (Core Algorithms)

### 2.1 è¯Šæ–­è¯„åˆ†ç®—æ³• (`src/lib/riskEngine.ts`)

ç›´æ¥ä½¿ç”¨æ­¤ä»£ç è®¡ç®—é›·è¾¾å›¾æ•°æ®ã€‚

```typescript
export const calculateRiskScore = (data: WizardData) => {
  let scores = { 
    tax: 100,        // ç¨åŠ¡ç­¹åˆ’
    security: 100,   // èµ„äº§å®‰å…¨
    succession: 100, // å®¶æ—ä¼ æ‰¿
    privacy: 100,    // éšç§ä¿æŠ¤
    compliance: 100  // åˆè§„æ€§
  };
  
  const risks: string[] = []; // æ”¶é›†è§¦å‘çš„é£é™©æ ‡ç­¾

  // --- è§„åˆ™ 1: ç¾å›½ç¨åŠ¡æ¸—é€ ---
  const usNodes = data.identities.filter(n => n.region === 'US');
  if (usNodes.length > 0) {
    scores.tax -= 30;       // å…¨çƒå¾ç¨ä¸¥é‡æ‰£åˆ†
    scores.compliance -= 20; // ç”³æŠ¥ä¹‰åŠ¡é‡
    scores.privacy -= 10;    // FATCA é€æ˜åŒ–
    risks.push("US_TAX_PERSON");
    
    // å­è§„åˆ™: èµ ä¸é£é™©
    if (usNodes.some(n => n.risks.includes('GIFT_REPORTING'))) {
      scores.tax -= 10;
      risks.push("US_GIFT_RISK");
    }
  }

  // --- è§„åˆ™ 2: åŠ /æ¾³ ç¦»å¢ƒç¨ ---
  const exitNodes = data.identities.filter(n => ['CA', 'AU'].includes(n.region));
  if (exitNodes.length > 0) {
    // å‡è®¾æœªæ¥å¯èƒ½å›æµæˆ–å˜åŠ¨
    scores.tax -= 20;
    scores.security -= 15; // èµ„äº§é”å®š
    risks.push("DEPARTURE_TAX_RISK");
  }

  // --- è§„åˆ™ 3: æ—¥æœ¬ç»§æ‰¿ç¨ ---
  const jpNodes = data.identities.filter(n => n.region === 'JP' && n.risks.includes('JP_UNLIMITED_LIABILITY'));
  if (jpNodes.length > 0) {
    scores.tax -= 40;        // 55% ç»§æ‰¿ç¨æé«˜
    scores.succession -= 30; // ä¼ æ‰¿å‡ ä¹è…°æ–©
    risks.push("JP_INHERITANCE_TAX");
  }

  // --- è§„åˆ™ 4: èµ„äº§ç»“æ„é£é™© ---
  if (data.assets.types.includes('trust') && usNodes.length > 0) {
    scores.compliance -= 25; // 3520A ç”³æŠ¥æå…¶å¤æ‚
    risks.push("US_FOREIGN_TRUST_TRAP");
  }
  
  if (data.assets.types.includes('equity') && data.assets.foreign > 1) {
    scores.privacy -= 20; // CRS ç©¿é€æ¦‚ç‡å¤§
    risks.push("CRS_EXPOSURE");
  }

  // --- è§„åˆ™ 5: ç—›ç‚¹ä¿®æ­£ ---
  if (data.painPoints.includes('heirs')) scores.succession -= 20;
  if (data.painPoints.includes('divorce')) scores.security -= 20;

  // å½’ä¸€åŒ– (æœ€ä½ 30 åˆ†)
  Object.keys(scores).forEach(k => {
    scores[k] = Math.max(30, scores[k]);
  });

  return { scores, risks };
};
```

### 2.2 æŸç›Šæ¨¡æ‹Ÿç®—æ³• (`src/lib/lossSimulator.ts`)

```typescript
export const calculateLoss = (data: WizardData) => {
  // 1. ä¼°ç®—æ€»èµ„äº§ (åŸºäºæ»‘å—åŒºé—´å–ä¸­å€¼)
  const domesticMap = [5000000, 30000000, 75000000, 200000000]; // RMB
  const foreignMap = [500000, 3000000, 12500000, 50000000];     // USD
  
  const totalUSD = (domesticMap[data.assets.domestic] / 7.2) + foreignMap[data.assets.foreign];
  
  let lossAmount = 0;
  let breakdown = [];

  // --- åœºæ™¯ A: é—äº§ç¨ (Estate Tax) ---
  // å‡è®¾ 40% èµ„äº§æš´éœ²åœ¨ç¾å›½/è‹±å›½/æ—¥æœ¬ç®¡è¾–ä¸‹
  const hasHighTaxRes = data.identities.some(n => ['US', 'UK', 'JP'].includes(n.region));
  if (hasHighTaxRes) {
    const exposedAssets = totalUSD * 0.4; 
    const taxRate = 0.40; // å¹³å‡ 40%
    const taxLoss = exposedAssets * taxRate;
    lossAmount += taxLoss;
    breakdown.push({ label: "è·¨å¢ƒé—äº§ç¨", amount: taxLoss, color: "bg-red-500" });
  }

  // --- åœºæ™¯ B: ç¦»å¢ƒç¨ (Exit Tax) ---
  const hasExitRisk = data.identities.some(n => ['CA', 'AU'].includes(n.region));
  if (hasExitRisk) {
    // å‡è®¾ 50% èµ„äº§ä¸ºå¢å€¼éƒ¨åˆ†ï¼Œç¨ç‡ 25%
    const exitLoss = totalUSD * 0.5 * 0.25;
    lossAmount += exitLoss;
    breakdown.push({ label: "ç¦»å¢ƒ/è§†åŒå”®å‡ºç¨", amount: exitLoss, color: "bg-orange-500" });
  }

  // --- åœºæ™¯ C: è¡Œæ”¿/æ³•å¾‹æ‘©æ“¦ ---
  const legalLoss = totalUSD * 0.05; // å›ºå®š 5%
  lossAmount += legalLoss;
  breakdown.push({ label: "è·¨å›½æ³•å¾‹/è¡Œæ”¿æˆæœ¬", amount: legalLoss, color: "bg-yellow-500" });

  const remainingRatio = Math.max(0.3, (totalUSD - lossAmount) / totalUSD);
  
  return {
    totalUSD,
    lossAmount,
    remainingRatio,
    breakdown
  };
};
```

---

## 3. é¡µé¢è¯¦ç»†å®ç°æŒ‡å— (Page Specs)

### 3.1 èº«ä»½å½•å…¥é¡µ (`IdentityStep.tsx`)
**äº¤äº’éš¾ç‚¹**ï¼š`dnd-kit` ä¸ æ¨¡æ€æ¡† çš„é…åˆã€‚

*   **çŠ¶æ€æœº (State Machine)**:
    *   `IDLE`: ç­‰å¾…æ‹–æ‹½ã€‚
    *   `DRAGGING`: æ‰˜ç›˜å›¾æ ‡åŠé€æ˜ï¼Œåœ°å›¾çƒ­åŒºé«˜äº®ã€‚
    *   `DROPPED`: è§¦å‘ `handleDragEnd`ã€‚
        *   `IF target == 'US'`: è¿›å…¥ `MODAL_US` çŠ¶æ€ã€‚
        *   `IF target == 'JP'`: è¿›å…¥ `MODAL_JP` çŠ¶æ€ã€‚
        *   `ELSE`: ç›´æ¥æ·»åŠ èŠ‚ç‚¹ï¼Œå› `IDLE`ã€‚
    *   `MODAL_XX`: æ˜¾ç¤ºé—®å·ã€‚
        *   `ON_CONFIRM`: å°†é—®å·ç»“æœ (Risks) å†™å…¥èŠ‚ç‚¹ï¼Œæ·»åŠ èŠ‚ç‚¹ï¼Œå› `IDLE`ã€‚
        *   `ON_CANCEL`: æ’¤é”€æ‹–æ‹½ï¼Œå› `IDLE`ã€‚

*   **UI ç»†èŠ‚**:
    *   **èº«ä»½é”šç‚¹ (Avatar)**: `w-12 h-12 rounded-full border-2 border-primary bg-secondary`.
    *   **å›½æ——å›¾æ ‡**: ä½¿ç”¨ `flag-icons` æˆ– SVGï¼Œå½“èŠ‚ç‚¹è½ä½æ—¶æ˜¾ç¤ºåœ¨å¤´åƒå³ä¸‹è§’ `absolute bottom-0 right-0`.

### 3.2 è¯Šæ–­é¡µ (`Diagnosis.tsx`)
**äº¤äº’éš¾ç‚¹**ï¼šåŠ¨ç”»æ—¶åº (Sequence)ã€‚

*   **åŠ¨ç”»åºåˆ—**:
    1.  `T=0s`: é¡µé¢åŠ è½½ï¼Œæ˜¾ç¤º "AI æ­£åœ¨åˆ†æ..." Loading é®ç½©ã€‚
    2.  `T=1.5s`: é®ç½©æ·¡å‡ºï¼Œ**äº”ç»´é›·è¾¾å›¾** ä»ä¸­å¿ƒå¼¹å¼€ (Scale 0->1)ã€‚
    3.  `T=2.0s`: **é£é™©çº¢ç»¿ç¯** å¡ç‰‡ä¾æ¬¡æ»‘å…¥ (Staggered Fade In)ã€‚
    4.  `T=3.0s`: **æŸç›Šè¿›åº¦æ¡** å¼€å§‹æ»šåŠ¨ç¼©å‡ (Width 100% -> 40%)ã€‚

---

## 4. æ ·å¼è§„èŒƒ (Tailwind Design Tokens)

è¯·åœ¨ `tailwind.config.js` æˆ– `index.css` ä¸­ä¸¥æ ¼å®šä¹‰ï¼š

```css
@theme inline {
  /* å“ç‰Œè‰² */
  --color-primary: #B87845;    /* å¤é“œé‡‘ */
  --color-background: #0C2340; /* æ·±é‚ƒè“ */
  --color-surface: #FFF2CC;    /* å¥¶æ²¹ç™½ */
  
  /* å­—ä½“ */
  --font-heading: 'Cinzel', serif;
  --font-body: 'Lato', sans-serif;
  
  /* åŠ¨ç”»æ›²çº¿ */
  --ease-luxury: cubic-bezier(0.22, 1, 0.36, 1);
}
```

---

**æ–‡æ¡£è¯´æ˜**ï¼š
æœ¬è“å›¾ (Blueprint) æ˜¯ V12 è§„æ ¼ä¹¦çš„ä»£ç çº§å®ç°ç‰ˆæœ¬ã€‚
è¯·å¼€å‘å›¢é˜Ÿç›´æ¥å¤åˆ¶ç¬¬ 2 èŠ‚çš„ç®—æ³•ä»£ç ï¼Œå¹¶å‚ç…§ç¬¬ 3 èŠ‚çš„çŠ¶æ€æœºé€»è¾‘ç¼–å†™ç»„ä»¶ã€‚
è¿™æ˜¯ä¸€ä»½**â€œç…§åšå³å¯â€**çš„æ‰§è¡Œæ–‡æ¡£ã€‚
