# 报告质量控制与定制化体系实施方案 (V7.0)

**日期**：2026-01-13
**目标**：构建一套“可编辑、可定制、质量可控”的报告生成体系，彻底解决 AI 输出不稳定和用户无法修改的问题。

---

## 🏗️ 核心架构：三层控制模型

为了满足您的需求，我们将把报告生成过程重构为三个阶段：**生成前定制 -> 生成中约束 -> 生成后修订**。

### 1. 第一层：生成前定制 (Pre-Generation Customization)
让用户在点击“生成”之前，就能控制报告的走向。

*   **功能设计**：
    *   在“生成报告”按钮上方增加**“侧重点配置”**面板。
    *   **语气选择**：`稳健保守` / `积极进取` / `客观中立`。
    *   **关注焦点**：`税务合规优先` / `家族传承优先` / `资产增值优先` / `风险隔离优先`。
    *   **篇幅控制**：`精简版 (500字)` / `标准版 (1000字)` / `深度版 (2000字)`。
*   **实现原理**：
    *   将用户的选择动态拼接到 Prompt 中（例如：“请以**积极进取**的口吻，重点分析**家族传承**相关风险...”）。

### 2. 第二层：生成中约束 (In-Generation Constraints)
确保 AI 输出的内容符合结构要求，不跑题，字数达标。

*   **JSON 结构化输出 (Structured Output)**：
    *   放弃纯文本 Markdown，强制 AI 返回 JSON 对象。
    *   ```json
        {
          "summary": { "text": "...", "word_count": 800 },
          "risks": [
            { "title": "代持风险", "content": "...", "severity": "High" }
          ],
          "conclusion": "..."
        }
        ```
*   **字数守门员 (Length Guard)**：
    *   后端收到 JSON 后，自动检查 `word_count`。
    *   如果字数不足，**自动触发“扩写”指令**进行重试，用户无感知，只看到最终合格的结果。

### 3. 第三层：生成后修订 (Post-Generation Editing) —— **核心升级**
这是解决“不满意”的终极手段。让报告变成一个**在线 Word**。

*   **所见即所得编辑器 (WYSIWYG)**：
    *   将现有的只读文本框升级为**富文本编辑器**。
    *   用户可以直接点击报告中的文字进行修改、删除、加粗。
*   **局部重写 (Granular Regenerate)**：
    *   在“摘要”、“痛点”、“建议”每个板块旁边添加一个 **“AI 重写”** 小按钮。
    *   觉得这一段写得不好？点一下只重写这一段，**节省 Token** 且速度快。
*   **版本快照**：
    *   每次修改后自动保存。
    *   提供“对比视图”，查看 AI 原文与人工修改后的区别。

---

## 📅 实施路线图 (Roadmap)

### Phase 1: 视觉修复与基础定制 (本次已完成)
*   ✅ **图谱布局修复**：强制限制宽度，防止溢出。
*   ✅ **样式优化**：深色标题、去图标化。

### Phase 2: 在线编辑能力 (Next Step)
*   引入轻量级编辑器（如 `TipTap` 或可编辑 `div`）。
*   让用户能直接修改 AI 生成的 `summary`、`analysis` 和 `conclusion`。
*   **保存逻辑升级**：保存时存储用户的修改版，而不是 AI 的原版。

### Phase 3: 深度定制面板
*   开发“生成配置”表单。
*   修改后端 Prompt 逻辑，适配用户的个性化参数。

---

## 💡 专家建议

我们建议**优先启动 Phase 2 (在线编辑)**。
因为无论 AI 多么智能，总会有不完美的地方。给用户一把“修改的钥匙”，是解决满意度问题的成本最低、效果最好的方案。
