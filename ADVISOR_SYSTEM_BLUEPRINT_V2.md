# é¡¾é—®ç«¯ç³»ç»Ÿ - å…¨åŠŸèƒ½æ·±åº¦å¼€å‘è§„æ ¼ä¹¦ (Advisor System Blueprint V2.0)

**ç‰ˆæœ¬**ï¼šV2.0
**æ€§è´¨**ï¼šç»ˆæå¼€å‘è“å›¾ (The Definitive Blueprint)
**é€‚ç”¨å¯¹è±¡**ï¼šå…¨æ ˆå¼€å‘äººå‘˜ã€äº§å“ç»ç†ã€æµ‹è¯•å·¥ç¨‹å¸ˆ
**æ ¸å¿ƒç›®æ ‡**ï¼šå°†æ‰€æœ‰æ¨¡ç³Šçš„éœ€æ±‚è½¬åŒ–ä¸º**å­—æ®µçº§ã€ä»£ç çº§**çš„æ‰§è¡Œæ ‡å‡†ã€‚

---

# ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨åŸŸæ•°æ®å­—å…¸ (Global Data Schema)

*è¿™æ˜¯ç³»ç»Ÿçš„åœ°åŸºã€‚æ‰€æœ‰é¡µé¢å’Œé€»è¾‘éƒ½å»ºç«‹åœ¨è¿™äº›æ•°æ®ç»“æ„ä¹‹ä¸Šã€‚*

## 1.1 å®¶æ—æˆå‘˜å¯¹è±¡ (FamilyMember Schema)
| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜/æšä¸¾å€¼ | ç”¨äºé€»è¾‘ |
| :--- | :--- | :--- | :--- | :--- |
| `id` | string | Y | UUID | å”¯ä¸€æ ‡è¯† |
| `name` | string | Y | å§“å | æ˜¾ç¤ºç”¨ |
| `relation` | enum | Y | `self` (æœ¬äºº), `spouse` (é…å¶), `child` (å­å¥³), `parent` (çˆ¶æ¯), `grandchild` (å­™è¾ˆ) | æ‹“æ‰‘ç»“æ„ |
| `parentId` | string | N | å…³è”çš„çˆ¶èŠ‚ç‚¹ ID | ç»˜åˆ¶æ ‘çŠ¶å›¾ |
| `nationality` | enum | Y | `CN`, `US`, `UK`, `CA`, `AU`, `SG`, `JP`, `HK` | **æ ¸å¿ƒç¨åŠ¡åˆ¤å®š** |
| `taxResidencies` | array | Y | `['CN', 'US']` (å¤šé‡ç¨åŠ¡å±…æ°‘èº«ä»½) | **CRS/FATCA åˆ¤å®š** |
| `daysInCountry` | number | N | å±…ä½å¤©æ•° (é’ˆå¯¹ US/UK/JP) | å®è´¨å±…ä½æµ‹è¯• |
| `domicile` | boolean | N | æ˜¯å¦ä¸ºå±…ç± (é’ˆå¯¹ UK) | RND æ±‡æ¬¾åˆ¶åˆ¤å®š |
| `healthStatus` | enum | Y | `healthy`, `sub_healthy`, `critical` | ä¿é™©è§„åˆ’é€»è¾‘ |
| `maritalStatus` | enum | Y | `single`, `married`, `divorced` | å©šå‰è´¢äº§éš”ç¦» |

## 1.2 èµ„äº§å¯¹è±¡ (Asset Schema)
| å­—æ®µå | ç±»å‹ | å¿…å¡« | è¯´æ˜/æšä¸¾å€¼ | ç”¨äºé€»è¾‘ |
| :--- | :--- | :--- | :--- | :--- |
| `id` | string | Y | UUID | |
| `name` | string | Y | èµ„äº§åç§° (å¦‚: æ›¼å“ˆé¡¿å…¬å¯“) | |
| `type` | enum | Y | `real_estate`, `equity`, `cash`, `insurance`, `trust`, `fund` | é£é™©åˆ†ç±» (PFIC/CFC) |
| `location` | enum | Y | 8 å›½åˆ—è¡¨ | è·¨å¢ƒç¨åŠ¡åˆ¤å®š |
| `ownerId` | string | Y | å…³è” `FamilyMember.id` | æƒå±åˆ†æ |
| `holdingType` | enum | Y | `individual` (ä¸ªäºº), `joint` (è”å), `company` (å…¬å¸), `trust` (ä¿¡æ‰˜), `nominee` (ä»£æŒ) | **æ¶æ„é£é™©æ‰«æ** |
| `marketValue` | number | Y | å½“å‰å¸‚ä»· (åŸå¸ç§) | é—äº§ç¨åŸºæ•° |
| `costBase` | number | N | å–å¾—æˆæœ¬ (åŸå¸ç§) | ç¦»å¢ƒç¨(å¢å€¼ç¨)åŸºæ•° |
| `currency` | enum | Y | `CNY`, `USD`, `GBP`, ... | æ±‡ç‡æ¢ç®— |
| `isPassive` | boolean | N | æ˜¯å¦ä¸ºè¢«åŠ¨èµ„äº§ (é’ˆå¯¹å…¬å¸è‚¡æƒ) | CFC è¢«åŠ¨æ‰€å¾—åˆ¤å®š |

---

# ğŸ–¥ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šé¡µé¢åŠŸèƒ½è¯¦è§£ (Page-by-Page Specs)

## é¡µé¢ 2.1ï¼šé¡¾é—®å·¥ä½œå° (Dashboard)
**è·¯ç”±**: `/dashboard`
*   **åŠŸèƒ½åŒº 1: ç»Ÿè®¡çœ‹æ¿**
    *   `Total Cases`: æ¡ˆä¾‹æ€»æ•°ã€‚
    *   `High Risk Cases`: é£é™©ç­‰çº§ä¸º High çš„æ¡ˆä¾‹æ•°ã€‚
*   **åŠŸèƒ½åŒº 2: æ¡ˆä¾‹åˆ—è¡¨ (Table)**
    *   åˆ—ï¼šå®¢æˆ·å§“åã€èµ„äº§è§„æ¨¡ã€æœ€åæ›´æ–°æ—¶é—´ã€**çŠ¶æ€** (è‰ç¨¿/å·²ç”Ÿæˆ/å·²äº¤ä»˜)ã€‚
    *   æ“ä½œï¼š[æ–°å»ºæ¡ˆä¾‹] [å¯¼å…¥æ¼”ç¤ºæ•°æ®] [åˆ é™¤]ã€‚

## é¡µé¢ 2.2ï¼šæ·±åº¦å½•å…¥ - å®¶æ—å›¾è°± (Deep Entry - Family)
**è·¯ç”±**: `/cases/:id/family`
**å¸ƒå±€**: å·¦ä¾§ç”»æ¿ (Canvas) + å³ä¾§å±æ€§æ  (Sidebar)ã€‚

*   **ç”»å¸ƒåŠŸèƒ½**:
    *   **æ·»åŠ èŠ‚ç‚¹**: ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„â€œ+â€æŒ‰é’®ï¼Œæ·»åŠ æ–°æˆå‘˜ã€‚
    *   **è¿çº¿**: è‡ªåŠ¨æ ¹æ® `parentId` å’Œ `partnerId` ç»˜åˆ¶è¿æ¥çº¿ã€‚
    *   **è§†è§‰ç¼–ç **:
        *   ç¾å›½èº«ä»½ -> èŠ‚ç‚¹è¾¹æ¡†å˜ä¸º **è“è‰²**ã€‚
        *   é‡ç–¾çŠ¶æ€ -> èŠ‚ç‚¹å³ä¸Šè§’æ˜¾ç¤º **çº¢åå­—** å›¾æ ‡ã€‚
*   **å±æ€§ä¾§è¾¹æ  (é€‰ä¸­èŠ‚ç‚¹æ—¶æ»‘å‡º)**:
    *   è¡¨å•æ¸²æŸ“ 1.1 ä¸­çš„æ‰€æœ‰å­—æ®µã€‚
    *   **æ™ºèƒ½æç¤º**: å½“é€‰æ‹© `nationality = US` æ—¶ï¼Œè‡ªåŠ¨å¼¹å‡ºæç¤ºâ€œè¯·ç¡®è®¤æ˜¯å¦æ”¾å¼ƒäº†ç»¿å¡ä½†æœªå®Œç¨ï¼Ÿâ€

## é¡µé¢ 2.3ï¼šæ·±åº¦å½•å…¥ - èµ„äº§å°è´¦ (Deep Entry - Assets)
**è·¯ç”±**: `/cases/:id/assets`
**å¸ƒå±€**: æ•°æ®è¡¨æ ¼ (Data Grid) + é¡¶éƒ¨ç»Ÿè®¡æ¡ã€‚

*   **äº¤äº’**:
    *   æ”¯æŒ Excel æ¨¡å¼çš„å•å…ƒæ ¼ç¼–è¾‘ã€‚
    *   **æ±‡ç‡è‡ªåŠ¨è®¡ç®—**: è¾“å…¥ `10,000,000 JPY`ï¼Œç³»ç»Ÿè‡ªåŠ¨æŒ‰å®æ—¶æ±‡ç‡æ˜¾ç¤º `~68,000 USD`ã€‚
*   **éªŒè¯é€»è¾‘**:
    *   å¦‚æœ `holdingType == 'nominee'` (ä»£æŒ)ï¼Œè¯¥è¡ŒèƒŒæ™¯**å˜çº¢**ï¼Œå¹¶å¼ºåˆ¶è¦æ±‚å¡«å†™â€œä»£æŒåè®®çŠ¶æ€â€ã€‚

## é¡µé¢ 2.4ï¼šæŠ¥å‘Šç”Ÿæˆé…ç½® (Report Config)
**è·¯ç”±**: `/cases/:id/generate`
**åŠŸèƒ½**: æ§åˆ¶ AI çš„å†™ä½œæ–¹å‘ã€‚

*   **é…ç½®é¡¹**:
    *   **è¯­æ°” (Tone)**: `ç¨³å¥ (Conservative)`, `æ¿€è¿› (Aggressive)`, `ä¸­ç«‹ (Neutral)`ã€‚
    *   **ç¯‡å¹… (Length)**: `ç²¾ç®€ (800 words)`, `æ ‡å‡† (1500 words)`, `æ·±åº¦ (3000 words)`ã€‚
    *   **ä¾§é‡ (Focus)**: `ç¨åŠ¡ä¼˜å…ˆ`, `ä¼ æ‰¿ä¼˜å…ˆ`, `èµ„äº§éš”ç¦»ä¼˜å…ˆ`ã€‚
*   **åŠ¨ä½œ**: ç‚¹å‡» [å¼€å§‹ç”Ÿæˆ] -> è§¦å‘ API è°ƒç”¨ -> è¿›å…¥ Loading çŠ¶æ€ (æ˜¾ç¤ºâ€œæ­£åœ¨æ£€ç´¢ 8 å›½ç¨æ³•...â€)ã€‚

## é¡µé¢ 2.5ï¼šæ™ºèƒ½æŠ¥å‘Šç¼–è¾‘å™¨ (The Editor)
**è·¯ç”±**: `/cases/:id/report/edit`
**æ ¸å¿ƒç»„ä»¶**: TipTap Editorã€‚

*   **æ–‡æ¡£ç»“æ„ (Document Structure)**:
    1.  **Title Block**: æŠ¥å‘Šæ ‡é¢˜ã€å®¢æˆ·åã€æ—¥æœŸã€‚
    2.  **Summary Block**: AI ç”Ÿæˆçš„æ‘˜è¦ (å¯ç¼–è¾‘)ã€‚
    3.  **Visual Block 1**: åµŒå…¥ `<FamilyTree />` ç»„ä»¶ (SVG æ¸²æŸ“ï¼ŒçŸ¢é‡é«˜æ¸…)ã€‚
    4.  **Visual Block 2**: åµŒå…¥ `<AssetPieChart />` ç»„ä»¶ã€‚
    5.  **Risk Analysis Block**: 
        *   æ¸²æŸ“ä¸ºâ€œçº¢ç»¿ç¯å¡ç‰‡æµâ€ã€‚
        *   æ¯ä¸ªå¡ç‰‡åŒ…å«ï¼šæ ‡é¢˜ã€é£é™©ç­‰çº§å›¾æ ‡ã€AI åˆ†ææ–‡æ¡ˆã€æ³•ç†å¼•ç”¨ã€‚
    6.  **Solutions Block**: æˆ˜ç•¥å»ºè®®åˆ—è¡¨ã€‚
*   **AI è¾…åŠ©å·¥å…·æ  (Floating Menu)**:
    *   é€‰ä¸­æ–‡æœ¬ -> å¼¹å‡ºèœå• -> [æ¶¦è‰²] [æ‰©å†™] [ç¼©å†™] [ç¿»è¯‘]ã€‚

---

# ğŸ§  ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒé€»è¾‘å¼•æ“ (Logic Engine)

*æ‰€æœ‰é€»è¾‘å¿…é¡»åœ¨å‰ç«¯ TS ä¸­å®ç°ï¼Œä¸ä¾èµ– AI çŒœæµ‹ã€‚*

## 3.1 é£é™©è§¦å‘å­—å…¸ (Risk Triggers)

### **R1: ç¾å›½å…¨çƒå¾ç¨ (US_GLOBAL_TAX)**
```typescript
if (member.nationality === 'US' || member.taxResidencies.includes('US') || member.daysInCountry >= 183) {
  return {
    code: 'US_GLOBAL_TAX',
    level: 'HIGH',
    desc: 'ç¾å›½ç¨åŠ¡å±…æ°‘ï¼Œå…¨çƒæ”¶å…¥éœ€å‘ IRS ç”³æŠ¥ (Form 1040)ã€‚'
  };
}
```

### **R2: è¢«åŠ¨å¤–å›½æŠ•èµ„å…¬å¸ (US_PFIC)**
```typescript
if (isUSPerson(owner) && asset.type === 'fund' && asset.location !== 'US') {
  return {
    code: 'US_PFIC',
    level: 'HIGH',
    desc: 'æŒæœ‰éç¾åŸºé‡‘ï¼Œè§¦å‘ç”Ÿå‰æŒ‰æœ€é«˜ç¨ç‡å¾ç¨åŠåˆ©æ¯ç½šæ¬¾ã€‚'
  };
}
```

### **R3: å—æ§å¤–å›½ä¼ä¸š (US_CFC)**
```typescript
if (isUSPerson(owner) && asset.type === 'equity' && asset.shareholding >= 10 && asset.location !== 'US') {
  return {
    code: 'US_CFC',
    level: 'HIGH',
    desc: 'æŒæœ‰éç¾å…¬å¸ >10% è‚¡ä»½ï¼Œå¯èƒ½è§¦å‘ Subpart F ç©¿é€å¾ç¨ã€‚'
  };
}
```

### **R4: åŠ æ‹¿å¤§ç¦»å¢ƒç¨ (CA_DEPARTURE)**
```typescript
if (member.taxResidencies.includes('CA') && member.status === 'planning_to_leave') {
  return {
    code: 'CA_DEPARTURE',
    level: 'HIGH',
    desc: 'ç¦»å¼€åŠ æ‹¿å¤§æ—¶ï¼Œåä¸‹å…¨çƒèµ„äº§è§†åŒæŒ‰å¸‚ä»·å‡ºå”® (Deemed Disposition)ã€‚'
  };
}
```

### **R5: æ—¥æœ¬ç™¾å¹´ç»§æ‰¿ç¨ (JP_INHERITANCE)**
```typescript
if (member.residence === 'JP' && member.yearsInJapan > 10) {
  return {
    code: 'JP_INHERITANCE',
    level: 'HIGH',
    desc: 'å±…ä½è¶… 10 å¹´ï¼Œå…¨çƒèµ„äº§é¢ä¸´æœ€é«˜ 55% ç»§æ‰¿ç¨ï¼Œä¸”è¿½æº¯æœŸé•¿ã€‚'
  };
}
```

## 3.2 AI Prompt æ¨¡æ¿ (Prompt Engineering)

```text
Role: æ‚¨æ˜¯æ‹¥æœ‰ 20 å¹´ç»éªŒçš„å®¶æ—åŠå…¬å®¤é¦–å¸­æ¶æ„å¸ˆã€‚
Context:
- å®¶æ—æˆå‘˜æ•°æ®: ${JSON.stringify(familyData)}
- èµ„äº§æ•°æ®: ${JSON.stringify(assetData)}
- ç³»ç»Ÿå·²è¯†åˆ«çš„ç¡¬æ€§é£é™©æ ‡ç­¾: ${JSON.stringify(riskTags)}

Task: è¯·ç”Ÿæˆä¸€ä»½ã€Šå®¶æ—è´¢å¯Œè¯Šæ–­æŠ¥å‘Šã€‹ï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹ JSON æ ¼å¼ï¼š
{
  "summary": "...", // 800å­—ï¼Œç»“åˆé£é™©æ ‡ç­¾è¿›è¡Œç»¼è¿°
  "risk_deep_dive": [
    { 
      "risk_code": "US_PFIC", 
      "analysis": "...", // è¯¦ç»†è§£é‡Šä¸ºä½•è¯¥å®¢æˆ·çš„åŸºé‡‘è§¦å‘äº† PFIC
      "legal_ref": "IRC Section 1297" // å¿…é¡»å¼•ç”¨æ³•æ¡
    }
  ],
  "solutions": { ... }
}

Tone: ${config.tone} (ç¨³å¥/æ¿€è¿›)
```

---

# ğŸ“… ç¬¬å››éƒ¨åˆ†ï¼šå¼€å‘åˆ†æ­¥è®¡åˆ’ (Implementation Roadmap)

## Phase 1: æ•°æ®å±‚é‡æ„ (Data Layer)
*   **Task 1.1**: æ›´æ–° `WizardContext`ï¼Œå®ç°ä¸Šè¿°å®Œæ•´çš„ `FamilyMember`å’Œ `Asset` æ¥å£ã€‚
*   **Task 1.2**: é‡å†™ `FamilyTree` ç»„ä»¶ï¼Œæ”¯æŒä¾§è¾¹æ å±æ€§ç¼–è¾‘ã€‚
*   **Task 1.3**: é‡å†™ `AssetList` ç»„ä»¶ï¼Œæ”¯æŒè¯¦ç»†å­—æ®µå½•å…¥ã€‚

## Phase 2: é€»è¾‘å±‚æ³¨å…¥ (Logic Layer)
*   **Task 2.1**: å®ç° `RiskEngine.ts`ï¼Œå°† 3.1 èŠ‚çš„æ‰€æœ‰ä¼ªä»£ç è½¬åŒ–ä¸º TypeScript å‡½æ•°ã€‚
*   **Task 2.2**: ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿â€œç¾ç±+åŸºé‡‘â€ä¸€å®šè§¦å‘ PFIC æŠ¥è­¦ã€‚

## Phase 3: è¡¨ç°å±‚å®ç° (Presentation Layer)
*   **Task 3.1**: é›†æˆ TipTap ç¼–è¾‘å™¨ã€‚
*   **Task 3.2**: å¼€å‘è‡ªå®šä¹‰ TipTap èŠ‚ç‚¹ï¼Œç”¨äºæ¸²æŸ“ `FamilyTree` å’Œ `RiskCard`ã€‚
*   **Task 3.3**: å¯¹æ¥ DeepSeek APIï¼Œè°ƒè¯• JSON è¾“å‡ºçš„ç¨³å®šæ€§ã€‚

---

**æ–‡æ¡£ç»“æŸ**
æœ¬è§„æ ¼ä¹¦å·²åŒ…å«å¼€å‘æ‰€éœ€çš„ä¸€åˆ‡ç»†èŠ‚ã€‚è¯·ç¡®è®¤æ˜¯å¦å¼€å§‹ **Phase 1 (æ•°æ®å±‚é‡æ„)** çš„å¼€å‘ï¼Ÿ
